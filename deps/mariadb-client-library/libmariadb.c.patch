@@ -2039,10 +2039,16 @@
 
   mysql->client_flag= client_flag;
 
+	{
+		volatile my_bool net_blocking = vio_is_blocking(net->vio);
+		if (!net_blocking)
+			vio_blocking(net->vio, TRUE, 0);
   if (run_plugin_auth(mysql, scramble_data, scramble_len,
                              scramble_plugin, db))
     goto error;
-
+		if (!net_blocking)
+			vio_blocking(net->vio, FALSE, 0);
+	}
   if (mysql->client_flag & CLIENT_COMPRESS)
     net->compress= 1;
 
@@ -2395,6 +2401,36 @@
     /* Clear pointers for better safety */
     bzero((char*) &mysql->options,sizeof(mysql->options));
     mysql->net.vio= 0;
+    if (mysql->free_me)
+      my_free((gptr) mysql);
+  }
+  DBUG_VOID_RETURN;
+}
+
+void STDCALL
+mysql_close_no_command(MYSQL *mysql)
+{
+   MYSQL_STMT *stmt;
+  DBUG_ENTER("mysql_close");
+  if (mysql)					/* Some simple safety */
+  {
+    LIST *li_stmt= mysql->stmts;
+
+    if (mysql->methods) {
+			if (mysql->net.vio) {
+				free_old_query(mysql);
+				mysql->status=MYSQL_STATUS_READY; /* Force command */
+    		mysql->reconnect=0;
+				end_server(mysql);
+			}
+		}
+    mysql_close_memory(mysql);
+    mysql_close_options(mysql);
+    mysql->host_info=mysql->user=mysql->passwd=mysql->db=0;
+
+    /* Clear pointers for better safety */
+    bzero((char*) &mysql->options,sizeof(mysql->options));
+    mysql->net.vio= 0;
     if (mysql->free_me)
       my_free(mysql);
   }
