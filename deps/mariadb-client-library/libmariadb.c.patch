@@ -396,7 +396,7 @@
 *****************************************************************************/
 
 ulong
-net_safe_read(MYSQL *mysql)
+net_safe_read(MYSQL *mysql, size_t tot_size)
 {
   NET *net= &mysql->net;
   ulong len=0;
@@ -406,7 +406,7 @@
   /* Don't give sigpipe errors if the client doesn't want them */
   set_sigpipe(mysql);
   if (net->vio != 0)
-    len=my_net_read(net);
+    len=my_net_read(net, tot_size);
   reset_sigpipe(mysql);
 
   if (len == packet_error || len == 0)
@@ -630,7 +630,7 @@
   }
   result=0;
   if (!skipp_check) {
-    result= ((mysql->packet_length=net_safe_read(mysql)) == packet_error ?
+    result= ((mysql->packet_length=net_safe_read(mysql, 0)) == packet_error ?
 	     1 : 0);
     DBUG_PRINT("info", ("packet_length=%llu", mysql->packet_length));
   }
@@ -820,7 +820,7 @@
   DBUG_ENTER("madb_skip_result");
 
   do {
-    pkt_len= net_safe_read(mysql);
+    pkt_len= net_safe_read(mysql, 0);
     if (pkt_len == packet_error)
       break;
   } while (pkt_len > 8 || mysql->net.read_pos[0] != 254);
@@ -1226,7 +1226,7 @@
   NET *net = &mysql->net;
   DBUG_ENTER("madb_read_rows");
 
-  if ((pkt_len= net_safe_read(mysql)) == packet_error)
+  if ((pkt_len= net_safe_read(mysql, 0)) == packet_error)
     DBUG_RETURN(0);
   if (!(result=(MYSQL_DATA*) my_malloc(sizeof(MYSQL_DATA),
 				       MYF(MY_WME | MY_ZEROFILL))))
@@ -1283,7 +1283,7 @@
       }
     }
     cur->data[field]=to;			/* End of last field */
-    if ((pkt_len=net_safe_read(mysql)) == packet_error)
+    if ((pkt_len=net_safe_read(mysql, 0)) == packet_error)
     {
       free_rows(result);
       DBUG_RETURN(0);
@@ -1315,7 +1315,7 @@
   ulong pkt_len,len;
   uchar *pos,*prev_pos, *end_pos;
 
-  if ((pkt_len=(uint) net_safe_read(mysql)) == packet_error)
+  if ((pkt_len=(uint) net_safe_read(mysql, 0)) == packet_error)
     return -1;
   
   if (pkt_len <= 8 && mysql->net.read_pos[0] == 254)
@@ -1881,7 +1881,7 @@
                  errno);
     goto error;
   }
-  if ((pkt_length=net_safe_read(mysql)) == packet_error)
+  if ((pkt_length=net_safe_read(mysql, 0)) == packet_error)
   {
     if (mysql->net.last_errno == CR_SERVER_LOST)
       my_set_error(mysql, CR_SERVER_LOST, SQLSTATE_UNKNOWN,
@@ -2039,10 +2039,16 @@
 
   mysql->client_flag= client_flag;
 
+	{
+		volatile my_bool net_blocking = vio_is_blocking(net->vio);
+		if (!net_blocking)
+			vio_blocking(net->vio, TRUE, 0);
   if (run_plugin_auth(mysql, scramble_data, scramble_len,
                              scramble_plugin, db))
     goto error;
-
+		if (!net_blocking)
+			vio_blocking(net->vio, FALSE, 0);
+	}
   if (mysql->client_flag & CLIENT_COMPRESS)
     net->compress= 1;
 
@@ -2210,36 +2216,39 @@
   else
     mysql->charset=default_charset_info;
 
-  mysql->user= (char *)user;
-  mysql->passwd= (char *)passwd;
-  mysql->db= (char *)db;
+	mysql->user= strdup(user ? user : "");
+  mysql->passwd= strdup(passwd ? passwd : "");
+  mysql->db= 0;
+
   rc= run_plugin_auth(mysql, 0, 0, 0, db);
 
   if (rc==0)
   {
-    LIST *li_stmt= mysql->stmts;
+    //LIST *li_stmt= mysql->stmts; // see bug #897
     my_free(s_user);
     my_free(s_passwd);
     my_free(s_db);
 
-    if (!(mysql->user=  my_strdup(user,MYF(MY_WME))) ||
-        !(mysql->passwd=my_strdup(passwd,MYF(MY_WME))) ||
-        !(mysql->db= db ? my_strdup(db,MYF(MY_WME)) : 0))
+		if (db && !(mysql->db= strdup(db)))
     {
       SET_CLIENT_ERROR(mysql, CR_OUT_OF_MEMORY, unknown_sqlstate, 0);
       rc= 1;
     }
 
-    for (;li_stmt;li_stmt= li_stmt->next)
-    {
-      MYSQL_STMT *stmt= (MYSQL_STMT *)li_stmt->data;
-      stmt->mysql= NULL;
-      SET_CLIENT_STMT_ERROR(stmt, CR_SERVER_LOST, SQLSTATE_UNKNOWN, 0);
-    }/* detach stmts */
+    //for (;li_stmt;li_stmt= li_stmt->next) // see bug #897
+    //{
+    //  MYSQL_STMT *stmt= (MYSQL_STMT *)li_stmt->data;
+    //  stmt->mysql= NULL;
+    //  SET_CLIENT_STMT_ERROR(stmt, CR_SERVER_LOST, SQLSTATE_UNKNOWN, 0);
+    //}/* detach stmts */
     mysql->stmts= NULL;
     
   } else
   {
+    free(mysql->user);
+    free(mysql->passwd);
+    free(mysql->db);
+
     mysql->user= s_user;
     mysql->passwd= s_passwd;
     mysql->db= s_db;
@@ -2396,6 +2405,36 @@
     bzero((char*) &mysql->options,sizeof(mysql->options));
     mysql->net.vio= 0;
     if (mysql->free_me)
+      my_free((gptr) mysql);
+  }
+  DBUG_VOID_RETURN;
+}
+
+void STDCALL
+mysql_close_no_command(MYSQL *mysql)
+{
+  //MYSQL_STMT *stmt;
+  DBUG_ENTER("mysql_close");
+  if (mysql)					/* Some simple safety */
+  {
+    //LIST *li_stmt= mysql->stmts;
+
+    if (mysql->methods) {
+			if (mysql->net.vio) {
+				free_old_query(mysql);
+				mysql->status=MYSQL_STATUS_READY; /* Force command */
+    		mysql->reconnect=0;
+				end_server(mysql);
+			}
+		}
+    mysql_close_memory(mysql);
+    mysql_close_options(mysql);
+    mysql->host_info=mysql->user=mysql->passwd=mysql->db=0;
+
+    /* Clear pointers for better safety */
+    bzero((char*) &mysql->options,sizeof(mysql->options));
+    mysql->net.vio= 0;
+    if (mysql->free_me)
       my_free(mysql);
   }
   DBUG_VOID_RETURN;
@@ -2433,7 +2472,7 @@
   ulong length;
   DBUG_ENTER("mthd_my_read_query_result");
 
-  if (!mysql || (length = net_safe_read(mysql)) == packet_error)
+  if (!mysql || (length = net_safe_read(mysql, 0)) == packet_error)
     DBUG_RETURN(1);
   free_old_query(mysql);			/* Free old result */
 get_info:
@@ -2464,7 +2503,7 @@
     }
     error=mysql_handle_local_infile(mysql, (char *)pos);
 
-    if ((length=net_safe_read(mysql)) == packet_error || error)
+    if ((length=net_safe_read(mysql, 0)) == packet_error || error)
       DBUG_RETURN(-1);
     goto get_info;				/* Get info packet */
   }
@@ -3510,19 +3549,27 @@
   DBUG_VOID_RETURN;
 }
 
-int STDCALL mysql_set_character_set(MYSQL *mysql, const char *csname)
+int STDCALL mysql_set_character_set(MYSQL *mysql, const char *csname, uint charsetnr)
 {
   const CHARSET_INFO *cs;
   DBUG_ENTER("mysql_set_character_set");
 
-  if (!csname)
+  if (!csname && !charsetnr)
     goto error;
 
-  if ((cs= mysql_find_charset_name(csname)))
-  {
-    char buff[64];
-
-    my_snprintf(buff, 63, "SET NAMES %s", cs->csname);
+  if (csname) {
+	cs = mysql_find_charset_name(csname);
+  } else {
+    cs = mysql_find_charset_nr(charsetnr); 
+  }
+  if (cs)
+  {
+    char buff[128];
+    if (csname) { // default behavior
+      my_snprintf(buff, 63, "SET NAMES %s", cs->csname);
+    } else {
+      my_snprintf(buff, 63, "SET NAMES %s COLLATE %s", cs->csname, cs->name);
+    }
     if (!mysql_real_query(mysql, buff, (uint)strlen(buff)))
     {
       mysql->charset= cs;
